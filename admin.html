<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ°´è¡¨åå°ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* é€šç”¨æ ·å¼ */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: "Microsoft YaHei", Arial, sans-serif; padding: 20px; background: #f4f7fa; color: #333; }
    h1, h2, h3 { text-align: center; margin-bottom: 15px; }
    .section { background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
    label { display: block; margin-bottom: 5px; font-size: 16px; }
    input, select, button { width: 100%; padding: 10px; margin-bottom: 15px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    button { background: #007bff; color: #fff; border: none; cursor: pointer; transition: background 0.3s; }
    button:hover { background: #0056b3; }
    #result { text-align: center; font-size: 16px; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #e0e0e0; padding: 10px; text-align: center; }
    th { background: #fafafa; font-weight: 600; }
    ul { list-style: none; padding: 0; }
    li { margin-bottom: 10px; }
    /* å“åº”å¼å¸ƒå±€ */
    @media (min-width: 768px) {
      .flex-row { display: flex; gap: 20px; }
      .flex-item { flex: 1; }
    }
  </style>
</head>
<body>
  <h1>æ°´è¡¨åå°ç®¡ç†ï¼ˆæ™®é€šæ°´ä»·ï¿¥2.8/å¨ï¼Œåº•é“ºæ°´ä»·ï¿¥3.4/å¨ï¼‰</h1>

  <div id="loginSection" class="section">
    <label>è¯·è¾“å…¥åå°å¯†ç ï¼š</label>
    <input type="password" id="passwordInput" placeholder="Password">
    <button onclick="checkPassword()">ç™»å½•</button>
    <div id="loginMsg" style="color:red; margin-top:10px;"></div>
  </div>

  <div id="adminContent" style="display:none;">
    <div class="section">
      <h2>ğŸ’§ æäº¤è¯»æ•°</h2>
      <div class="flex-row">
        <div class="flex-item">
          <label>é€‰æ‹©ä½æˆ·ï¼š</label>
          <select id="householdSelect"></select>
        </div>
        <div class="flex-item">
          <label>è¯»æ•°æ—¥æœŸï¼š</label>
          <input type="date" id="dateInput">
        </div>
      </div>
      <div class="flex-row">
        <div class="flex-item">
          <label>æ°´è¡¨è¯»æ•°ï¼ˆå¨ï¼‰ï¼š</label>
          <input type="number" id="readingInput">
        </div>
        <div class="flex-item">
          <label>æ°´æŸè€—ï¼ˆå¨ï¼‰ï¼š</label>
          <input type="number" id="lossInput" value="3">
        </div>
      </div>
      <button onclick="submitData()">æäº¤è¯»æ•°</button>
    </div>

    <div class="section">
      <h2>ğŸ  ä½æˆ·ç®¡ç†</h2>
      <div class="flex-row">
        <div class="flex-item">
          <h3>æ·»åŠ ä½æˆ·</h3>
          <label>æˆ¿å·ï¼š</label>
          <input type="text" id="newId" placeholder="ä¾‹ï¼š3-101">
          <label>å§“åï¼š</label>
          <input type="text" id="newName" placeholder="ä¾‹ï¼šå¼ ä¸‰">
          <button onclick="addHousehold()">æ·»åŠ ä½æˆ·</button>
        </div>
        <div class="flex-item">
          <h3>ä¿®æ”¹ä½æˆ·å§“å</h3>
          <label>é€‰æ‹©ä½æˆ·ï¼š</label>
          <select id="editHouseholdSelect"></select>
          <label>æ–°å§“åï¼š</label>
          <input type="text" id="editName">
          <button onclick="editHousehold()">ä¿®æ”¹å§“å</button>
        </div>
        <div class="flex-item">
          <h3>åˆ é™¤ä½æˆ·</h3>
          <label>é€‰æ‹©ä½æˆ·ï¼š</label>
          <select id="deleteHouseholdSelect"></select>
          <button onclick="deleteHousehold()">åˆ é™¤ä½æˆ·</button>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>ğŸ“ è®°å½•ç®¡ç†</h2>
      <div class="flex-row">
        <div class="flex-item">
          <label>é€‰æ‹©ä½æˆ·ï¼š</label>
          <select id="recordHouseholdSelect" onchange="populateRecordList()"></select>
          <ul id="recordList"></ul>
        </div>
        <div class="flex-item">
          <h3>ä¿®æ”¹é€‰ä¸­è®°å½•</h3>
          <label>è¯»æ•°æ—¥æœŸï¼š</label>
          <input type="date" id="editRecordDate">
          <label>æ°´è¡¨è¯»æ•°ï¼ˆå¨ï¼‰ï¼š</label>
          <input type="number" id="editRecordReading">
          <label>æ°´æŸè€—ï¼ˆå¨ï¼‰ï¼š</label>
          <input type="number" id="editRecordLoss">
          <button onclick="modifySelectedRecord()">ä¿®æ”¹è®°å½•</button>
          <button onclick="deleteSelectedRecord()" style="background:#dc3545; margin-top:10px;">åˆ é™¤è®°å½•</button>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>ğŸ“Š ç”¨æ°´æ€»è§ˆ</h2>
      <button onclick="showOverview()">åˆ·æ–°æ€»è§ˆ</button>
      <div id="overview"></div>
    </div>

    <div class="section">
      <h2>ğŸ“ å¯¼å‡ºæ•°æ®ï¼ˆExcelï¼‰</h2>
      <button onclick="exportExcel()">å¯¼å‡º Excel æŠ¥è¡¨</button>
    </div>

    <div id="result"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const DEFAULT_PRICE = 2.8;
    const BOTTOM_PRICE = 3.4;
    let households = [];

    function checkPassword() {
      const pw = document.getElementById('passwordInput').value;
      if (pw === 'admin123') {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
        loadData();
      } else {
        document.getElementById('loginMsg').innerText = 'å¯†ç é”™è¯¯';
      }
    }

    function loadData() {
      fetch('https://hahagw.eu.org/data')
        .then(res => res.json())
        .then(data => {
          households = data.households;
          sortHouseholds();
          refreshAllSelects();
          populateRecordList();
          showOverview();
        });
    }

    function sortHouseholds() {
      households.sort((a, b) => a.id.localeCompare(b.id, 'zh-Hans-CN', { numeric: true }));
    }

    function refreshAllSelects() {
      ['householdSelect','editHouseholdSelect','deleteHouseholdSelect','recordHouseholdSelect'].forEach(id => {
        const sel = document.getElementById(id);
        sel.innerHTML = '';
        households.forEach(h => {
          const opt = document.createElement('option');
          opt.value = h.id;
          opt.textContent = `${h.id} - ${h.name}`;
          sel.appendChild(opt);
        });
      });
    }

    function uploadData(msg) {
      fetch('https://hahagw.eu.org/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({households})})
        .then(res=>res.text())
        .then(txt=>result.innerText = msg + 'ï¼š' + txt)
        .catch(err=>result.innerText = 'âŒ ä¸Šä¼ å¤±è´¥: ' + err);
    }

    function addHousehold() {
      const id = newId.value.trim(), name=newName.value.trim();
      if(!id||!name) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
      if(households.some(h=>h.id===id)) return alert('è¯¥æˆ¿å·å·²å­˜åœ¨');
      const date=new Date().toISOString().split('T')[0];
      households.push({id, name, records:[{date, reading:null}]});
      sortHouseholds(); refreshAllSelects();
      uploadData('âœ… ä½æˆ·å·²æ·»åŠ ');
    }

    function submitData() {
      const id=householdSelect.value, date=dateInput.value;
      const reading=Number(readingInput.value), loss=Number(lossInput.value);
      if(!date||isNaN(reading)||isNaN(loss)) return alert('è¯·å¡«å†™å®Œæ•´è¯»æ•°');
      const h=households.find(x=>x.id===id);
      const lastRec=h.records[0];
      const lastReading = lastRec.reading||0;
      const usage=reading - lastReading;
      const price=h.name.includes('åº•é“º')?BOTTOM_PRICE:DEFAULT_PRICE;
      const fee=(usage+loss)*price;
      h.records.unshift({date, reading, usage, loss, price, fee});
      uploadData('âœ… è¯»æ•°å·²æäº¤');
    }

    function populateRecordList() {
      const h=households.find(x=>x.id===recordHouseholdSelect.value);
      recordList.innerHTML='';
      h.records.forEach((r,i)=>{
        const li=document.createElement('li');
        li.innerHTML=`<label><input type="radio" name="recIdx" value="${i}"> ${r.date} | ${r.reading||"-"} å¨ | æŸè€— ${r.loss||"-"} | ï¿¥${(r.fee||0).toFixed(2)}</label>`;
        recordList.appendChild(li);
      });
      document.querySelectorAll('input[name=recIdx]').forEach(el=>el.onchange=fillEditFields);
    }

    function fillEditFields() {
      const h=households.find(x=>x.id===recordHouseholdSelect.value);
      const idx=Number(document.querySelector('input[name=recIdx]:checked').value);
      const r=h.records[idx];
      editRecordDate.value=r.date;
      editRecordReading.value=r.reading;
      editRecordLoss.value=r.loss;
    }

    function modifySelectedRecord() {
      const h=households.find(x=>x.id===recordHouseholdSelect.value);
      const sel=document.querySelector('input[name=recIdx]:checked');
      if(!sel) return alert('è¯·é€‰æ‹©è¦ä¿®æ”¹çš„è®°å½•');
      const i=Number(sel.value), date=editRecordDate.value;
      const reading=Number(editRecordReading.value), loss=Number(editRecordLoss.value);
      if(!date||isNaN(reading)||isNaN(loss)) return alert('è¯·å¡«å†™å®Œæ•´ä¿®æ”¹ä¿¡æ¯');
      const prev=h.records[i+1];
      const last=prev?prev.reading:0;
      const usage=reading-last;
      const price=h.name.includes('åº•é“º')?BOTTOM_PRICE:DEFAULT_PRICE;
      const fee=(usage+loss)*price;
      h.records[i]={date, reading, usage, loss, price, fee};
      populateRecordList(); uploadData('âœ… è®°å½•å·²ä¿®æ”¹');
    }

    function deleteSelectedRecord() {
      const h=households.find(x=>x.id===recordHouseholdSelect.value);
      const sel=document.querySelector('input[name=recIdx]:checked');
      if(!sel) return alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„è®°å½•');
      if(!confirm('ç¡®è®¤åˆ é™¤è¯¥è®°å½•ï¼Ÿ')) return;
      h.records.splice(Number(sel.value),1);
      if(h.records.length===1){ const r=h.records[0]; h.records[0]={date:r.date, reading:r.reading}; }
      populateRecordList(); uploadData('âœ… è¯»æ•°è®°å½•å·²åˆ é™¤');
    }

    function editHousehold() {
      const h=households.find(x=>x.id===editHouseholdSelect.value);
      const name=editName.value.trim(); if(!name) return alert('è¯·è¾“å…¥æ–°å§“å');
      h.name=name; refreshAllSelects(); uploadData('âœ… å§“åå·²ä¿®æ”¹');
    }

    function deleteHousehold() {
      const id=deleteHouseholdSelect.value;
      const h=households.find(x=>x.id===id);
      if(!confirm(`ç¡®è®¤åˆ é™¤ä½æˆ· ${h.id} - ${h.name} å—ï¼Ÿ`)) return;
      households=households.filter(x=>x.id!==id);
      refreshAllSelects(); uploadData('âœ… ä½æˆ·å·²åˆ é™¤');
    }

    function showOverview() {
      let html='<table><tr><th>æˆ¿å·</th><th>å§“å</th><th>å½“å‰è¯»æ•°</th><th>ç´¯è®¡ç”¨æ°´</th><th>ç´¯è®¡æŸè€—</th><th>ç´¯è®¡æ°´è´¹</th></tr>';
      households.forEach(h=>{
        const now=h.records[0].reading||0;
        const usage=h.records.reduce((s,r)=>(s+(r.usage||0)),0);
        const loss=h.records.reduce((s,r)=>(s+(r.loss||0)),0);
        const fee=h.records.reduce((s,r)=>(s+(r.fee||0)),0);
        html+=`<tr><td>${h.id}</td><td>${h.name}</td><td>${now}</td><td>${usage}</td><td>${loss}</td><td>ï¿¥${fee.toFixed(2)}</td></tr>`;
      });
      html+='</table>';
      overview.innerHTML=html;
    }

    function exportExcel() {
      const data=households.map(h=>({æˆ¿å·:h.id, å§“å:h.name, å½“å‰è¯»æ•°:h.records[0].reading||0, ç´¯è®¡ç”¨æ°´:h.records.reduce((s,r)=>(s+(r.usage||0)),0), ç´¯è®¡æŸè€—:h.records.reduce((s,r)=>(s+(r.loss||0)),0), ç´¯è®¡æ°´è´¹:h.records.reduce((s,r)=>(s+(r.fee||0)),0)}));
      const ws=XLSX.utils.json_to_sheet(data);
      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"æ°´è´¹æŠ¥è¡¨");
      XLSX.writeFile(wb,"æ°´è´¹æŠ¥è¡¨.xlsx");
    }
  </script>
</body>
</html>
