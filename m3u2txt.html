<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线M3U转TXT格式</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        h3 {
            color: #34495e;
        }
        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            box-sizing: border-box;
        }
        .buttons {
            margin: 20px 0;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 0 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        hr {
            border: 0;
            border-top: 1px solid #eee;
            margin: 30px 0;
        }
        footer {
            text-align: center;
            margin-top: 50px;
            color: #777;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>在线M3U转TXT格式</h1>
    <hr>
    <h3>M3U格式源:</h3>
    <textarea id="input" placeholder="请在此粘贴M3U播放列表内容（支持标准M3U和扩展M3U格式）"></textarea>
    
    <div class="buttons">
        <button onclick="convert()">转换格式</button>
        <button onclick="clearAll()">清除屏幕</button>
        <button onclick="copyResult()">拷贝结果</button>
        <button onclick="saveTxt()">保存txt</button>
    </div>
    
    <hr>
    <h3>TXT格式转换结果:</h3>
    <textarea id="output" readonly placeholder="转换结果将显示在这里"></textarea>
    
    <footer>© 2026 All Rights Reserved.</footer>

    <script>
        function convert() {
            const input = document.getElementById('input').value.trim();
            if (!input) {
                alert('请输入M3U内容');
                return;
            }

            const lines = input.split('\n');
            let result = [];
            let currentGroup = null;  // 当前分组
            let groupInserted = false;  // 当前分组的 #genre# 是否已插入

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();

                if (line.startsWith('#EXTM3U')) {
                    continue;
                }

                if (line.startsWith('#EXTINF:')) {
                    // 提取 group-title
                    let group = '未分组';
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    if (groupMatch && groupMatch[1].trim() !== '') {
                        group = groupMatch[1].trim();
                    }

                    // 如果分组切换，需要先插入上一组的 genre（如果有频道），然后重置
                    if (currentGroup !== null && currentGroup !== group && result.length > 0) {
                        // 上一组已结束，不需要额外操作，因为 genre 已经在第一个频道前插入
                        groupInserted = false;
                    }

                    // 如果是新分组且还未插入 genre 行，则先插入
                    if (currentGroup !== group) {
                        currentGroup = group;
                        result.push(currentGroup + ',#genre#');
                        groupInserted = true;
                    }

                    // 提取频道名称（最后一个逗号后的内容）
                    const parts = line.split(',');
                    const name = parts[parts.length - 1].trim();

                    // 查找下一行的 URL
                    let url = '';
                    for (let j = i + 1; j < lines.length; j++) {
                        let nextLine = lines[j].trim();
                        if (nextLine && !nextLine.startsWith('#')) {
                            url = nextLine;
                            i = j;  // 跳过已处理的 URL 行
                            break;
                        }
                    }

                    if (name && url) {
                        result.push(name + ',' + url);
                    }
                }
            }

            document.getElementById('output').value = result.join('\n');
        }

        function clearAll() {
            document.getElementById('input').value = '';
            document.getElementById('output').value = '';
        }

        function copyResult() {
            const output = document.getElementById('output');
            if (!output.value) {
                alert('没有可拷贝的内容');
                return;
            }
            output.select();
            document.execCommand('copy');
            alert('已拷贝到剪贴板');
        }

        function saveTxt() {
            const output = document.getElementById('output').value;
            if (!output) {
                alert('没有可保存的内容');
                return;
            }
            const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'playlist.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
